biigle.$viewModel("maia-job-form",function(e){new Vue({el:e,data:{showAdvanced:!1},methods:{toggle:function(){this.showAdvanced=!this.showAdvanced}}})}),biigle.$viewModel("maia-show-container",function(e){var n=biigle.$require("maia.job"),t=biigle.$require("maia.states"),i=biigle.$require("maia.api.maiaJob"),r=biigle.$require("maia.api.maiaAnnotation"),a=biigle.$require("messages.store"),s=biigle.$require("annotations.stores.images");new Vue({el:e,mixins:[biigle.$require("core.mixins.loader")],components:{sidebar:biigle.$require("annotations.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),selectTpTab:biigle.$require("maia.components.selectTpTab"),tpImageGrid:biigle.$require("maia.components.tpImageGrid"),refineTpTab:biigle.$require("maia.components.refineTpTab"),refineTpCanvas:biigle.$require("maia.components.refineTpCanvas")},data:{visitedSelectTpTab:!1,visitedRefineTpTab:!1,visitedReviewAcTab:!1,openTab:"info",trainingProposals:[],selectTpOffset:0,lastSelectedTp:null,currentImage:null,currentTpIndex:0},computed:{infoTabOpen:function(){return"info"===this.openTab},selectTpTabOpen:function(){return"select-training-proposals"===this.openTab},refineTpTabOpen:function(){return"refine-training-proposals"===this.openTab},reviewAcTabOpen:function(){return"review-annotation-candidates"===this.openTab},hasTrainingProposals:function(){return this.trainingProposals.length>0},isInTrainingProposalState:function(){return n.state_id===t["training-proposals"]},imageIds:function(){var e={};return this.trainingProposals.map(function(e){return e.image_id}).filter(function(n){return!e.hasOwnProperty(n)&&(e[n]=!0)})},tpById:function(){var e={};return this.trainingProposals.forEach(function(n){e[n.id]=n}),e},tpOrderedByImageId:function(){return this.trainingProposals.slice().sort(function(e,n){return e.image_id-n.image_id})},selectedTpOrderedByImageId:function(){return this.tpOrderedByImageId.filter(function(e){return e.selected})},previousTpIndex:function(){return(this.currentTpIndex+this.selectedTpOrderedByImageId.length-1)%this.selectedTpOrderedByImageId.length},nextTpIndex:function(){return(this.currentTpIndex+1)%this.selectedTpOrderedByImageId.length},currentTp:function(){return this.selectedTpOrderedByImageId.length>0&&this.refineTpTabOpen?this.selectedTpOrderedByImageId[this.currentTpIndex]:null},hasNoSelectedTp:function(){return 0===this.selectedTpOrderedByImageId.length},currentImageIdsIndex:function(){return this.imageIds.indexOf(this.currentImageId)},currentImageId:function(){return this.currentTp?this.currentTp.image_id:null},previousImageIdsIndex:function(){return(this.currentImageIdsIndex+this.imageIds.length-1)%this.imageIds.length},previousImageId:function(){return this.imageIds[this.nextImageIdsIndex]},nextImageIdsIndex:function(){return(this.currentImageIdsIndex+1)%this.imageIds.length},nextImageId:function(){return this.imageIds[this.nextImageIdsIndex]},tpForCurrentImage:function(){return this.hasCurrentImage?this.trainingProposals.filter(function(e){return e.image_id===this.currentImageId},this):[]},selectedTpForCurrentImage:function(){return this.tpForCurrentImage.filter(function(e){return e.selected})},currentTpArray:function(){return this.hasCurrentImage&&this.currentTp?[this.currentTp]:[]},hasCurrentImage:function(){return null!==this.currentImage},visitedSelectOrRefineTpTab:function(){return this.visitedSelectTpTab||this.visitedRefineTpTab}},methods:{handleSidebarToggle:function(){this.$nextTick(function(){this.$refs.imageGrid.$emit("resize")})},handleTabOpened:function(e){this.openTab=e},setTrainingProposals:function(e){this.trainingProposals=e.body.map(function(e){return e.shape="Circle",e})},fetchTrainingProposals:function(){return this.startLoading(),i.getTrainingProposals({id:n.id}).then(this.setTrainingProposals).catch(a.handleErrorResponse).finally(this.finishLoading)},openRefineTpTab:function(){this.openTab="refine-training-proposals"},handleSelectedTrainingProposal:function(e,n){e.selected?(e.selected=!1,r.update({id:e.id},{selected:!1}).catch(function(n){a.handleErrorResponse(n),e.selected=!0})):n.shiftKey&&this.lastSelectedTp?this.selectAllTpBetween(e,this.lastSelectedTp):(this.lastSelectedTp=e,this.storeSelectTrainingProposal(e))},updateSelectTpOffset:function(e){this.selectTpOffset=e},selectAllTpBetween:function(e,n){var t=this.trainingProposals.indexOf(e),i=this.trainingProposals.indexOf(n);if(i<t){var r=i;i=t,t=r}for(var a=t+1;a<=i;a++)this.storeSelectTrainingProposal(this.trainingProposals[a])},storeSelectTrainingProposal:function(e){e.selected=!0,r.update({id:e.id},{selected:!0}).catch(function(n){a.handleErrorResponse(n),e.selected=!1})},fetchCurrentImage:function(){return this.startLoading(),s.fetchAndDrawImage(this.currentImageId).catch(function(e){a.danger(e)}).then(this.setCurrentImage).then(this.cacheNextImage).finally(this.finishLoading)},setCurrentImage:function(e){this.currentImage=e},cacheNextImage:function(){this.currentImageId!==this.nextImageId&&s.fetchImage(this.nextImageId).catch(function(){})},handleNext:function(){this.currentTpIndex=this.nextTpIndex},handlePrevious:function(){this.currentTpIndex=this.previousTpIndex},handleRefineTp:function(e){Vue.Promise.all(e.map(this.updateTpPoints)).catch(a.handleErrorResponse)},updateTpPoints:function(e){var n=this;return r.update({id:e.id},{points:e.points}).then(function(){n.tpById[e.id].points=e.points})},focusCurrentTp:function(){this.$refs.refineCanvas.focusAnnotation(this.currentTp,!0,!1)}},watch:{selectTpTabOpen:function(){this.visitedSelectTpTab=!0},refineTpTabOpen:function(){this.visitedRefineTpTab=!0},reviewAcTabOpen:function(){this.visitedReviewAcTab=!0},visitedSelectOrRefineTpTab:function(){this.fetchTrainingProposals()},currentImageId:function(e){e?this.fetchCurrentImage().then(this.focusCurrentTp):this.setCurrentImage(null)},currentTp:function(e){e&&this.focusCurrentTp()}}})}),biigle.$declare("maia.api.maiaAnnotation",Vue.resource("api/v1/maia-annotations{/id}",{},{getFile:{method:"GET",url:"api/v1/maia-annotations{/id}/file"}})),biigle.$declare("maia.api.maiaJob",Vue.resource("api/v1/maia-jobs{/id}",{},{save:{method:"POST",url:"api/v1/volumes{/id}/maia-jobs"},getTrainingProposals:{method:"GET",url:"api/v1/maia-jobs{/id}/training-proposals"}})),biigle.$component("maia.components.refineTpCanvas",{mixins:[biigle.$require("annotations.components.annotationCanvas")],computed:{},methods:{toggleMarkAsInteresting:function(){console.log("toggle")}}}),biigle.$component("maia.components.refineTpTab",{props:{trainingProposals:{type:Array,required:!0}},data:function(){return{}},computed:{hasNoSelectedTp:function(){return!this.trainingProposals.reduce(function(e,n){return e||n.selected},!1)}},methods:{},created:function(){}}),biigle.$component("maia.components.selectTpTab",{props:{trainingProposals:{type:Array,required:!0}},data:function(){return{}},computed:{selectedTp:function(){return this.trainingProposals.filter(function(e){return e.selected})},selectedTpCount:function(){return this.selectedTp.length},tpCount:function(){return this.trainingProposals.length}},methods:{proceed:function(){this.$emit("proceed")}},created:function(){}}),biigle.$component("maia.components.tpImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("maia.components.tpImageGridImage")}}),biigle.$component("maia.components.tpImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage")],template:'<figure class="image-grid__image" :class="classObject" :title="title"><div v-if="showIcon" class="image-icon"><i class="fas fa-3x" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div></figure>',computed:{showAnnotationLink:function(){return!1},selected:function(){return this.image.selected},title:function(){return this.selected?"Undo marking as interesting":"Mark as interesting"}},methods:{getBlob:function(){return biigle.$require("maia.api.maiaAnnotation").getFile({id:this.image.id})}}});