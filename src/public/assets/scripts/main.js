biigle.$viewModel("maia-job-form",function(e){new Vue({el:e,data:{showAdvanced:!1},methods:{toggle:function(){this.showAdvanced=!this.showAdvanced}}})}),biigle.$viewModel("maia-show-container",function(e){var n=biigle.$require("maia.job"),t=biigle.$require("maia.states"),i=biigle.$require("maia.api.maiaJob"),a=biigle.$require("maia.api.maiaAnnotation"),s=biigle.$require("messages.store"),o=biigle.$require("annotations.stores.images"),r=biigle.$require("maia.imageIds"),c=[],l={};new Vue({el:e,mixins:[biigle.$require("core.mixins.loader")],components:{sidebar:biigle.$require("annotations.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),selectTpTab:biigle.$require("maia.components.selectTpTab"),tpImageGrid:biigle.$require("maia.components.tpImageGrid"),refineTpTab:biigle.$require("maia.components.refineTpTab"),refineTpCanvas:biigle.$require("maia.components.refineTpCanvas"),reviewAcTab:biigle.$require("maia.components.reviewAcTab"),acImageGrid:biigle.$require("maia.components.acImageGrid")},data:{visitedSelectTpTab:!1,visitedRefineTpTab:!1,visitedReviewAcTab:!1,openTab:"info",fetchTrainingProposalPromise:null,hasTrainingProposals:!1,selectedTrainingProposalIds:{},lastSelectedTp:null,currentImage:null,currentImageIndex:null,currentTrainingProposals:[],annotationCandidates:[]},computed:{infoTabOpen:function(){return"info"===this.openTab},selectTpTabOpen:function(){return"select-training-proposals"===this.openTab},refineTpTabOpen:function(){return"refine-training-proposals"===this.openTab},reviewAcTabOpen:function(){return"review-annotation-candidates"===this.openTab},isInTrainingProposalState:function(){return n.state_id===t["training-proposals"]},isInAnnotationCandidateState:function(){return n.state_id===t["annotation-candidates"]},trainingProposals:function(){return this.hasTrainingProposals?c:[]},selectedTrainingProposals:function(){return Object.keys(this.selectedTrainingProposalIds).map(function(e){return l[e]})},currentImageId:function(){return r[this.currentImageIndex]},nextImageIndex:function(){return(this.currentImageIndex+1)%r.length},nextImageId:function(){return r[this.nextImageIndex]},previousImageIndex:function(){return(this.currentImageIndex-1+r.length)%r.length},previousImageId:function(){return r[this.previousImageIndex]},hasCurrentImage:function(){return null!==this.currentImage},selectedAndSeenTrainingProposals:function(){return[]},hasNoSelectedTp:function(){return 0===this.selectedTrainingProposals.length}},methods:{handleSidebarToggle:function(){this.$nextTick(function(){this.$refs.imageGrid.$emit("resize")})},handleTabOpened:function(e){this.openTab=e},setTrainingProposals:function(e){c=e.body,c.forEach(function(e){l[e.id]=e,this.setSelectedTrainingProposalId(e)},this),this.hasTrainingProposals=c.length>0},fetchTrainingProposals:function(){return this.fetchTrainingProposalPromise||(this.startLoading(),this.fetchTrainingProposalPromise=i.getTrainingProposals({id:n.id}),this.fetchTrainingProposalPromise.then(this.setTrainingProposals).catch(s.handleErrorResponse).finally(this.finishLoading)),this.fetchTrainingProposalPromise},openRefineTpTab:function(){this.openTab="refine-training-proposals"},handleSelectedTrainingProposal:function(e,n){e.selected?this.updateSelectTrainingProposal(e,!1):n.shiftKey&&this.lastSelectedTp?this.selectAllTpBetween(e,this.lastSelectedTp):(this.lastSelectedTp=e,this.updateSelectTrainingProposal(e,!0))},selectAllTpBetween:function(e,n){var t=this.trainingProposals.indexOf(e),i=this.trainingProposals.indexOf(n);if(i<t){var a=i;i=t,t=a}for(var s=t+1;s<=i;s++)this.updateSelectTrainingProposal(this.trainingProposals[s],!0)},updateSelectTrainingProposal:function(e,n){e.selected=n,this.setSelectedTrainingProposalId(e),a.update({id:e.id},{selected:n}).catch(function(t){s.handleErrorResponse(t),e.selected=!n,this.setSelectedTrainingProposalId(e)})},setSelectedTrainingProposalId:function(e){e.selected?Vue.set(this.selectedTrainingProposalIds,e.id,!0):Vue.delete(this.selectedTrainingProposalIds,e.id)},fetchImage:function(e){this.startLoading();var n=o.fetchAndDrawImage(e);return n.catch(function(e){s.danger(e)}).then(this.cacheNextImage).finally(this.finishLoading),n},fetchTpAnnotations:function(e){return i.getTrainingProposalPoints({jobId:n.id,imageId:e})},setCurrentImageAndTpAnnotations:function(e){this.currentImage=e[0];var n=Object.keys(e[1].body);this.currentTrainingProposals=n.map(function(n){return{id:n,shape:"Circle",points:e[1].body[n]}}),console.log(this.currentTrainingProposals)},cacheNextImage:function(){this.currentImageId!==this.nextImageId&&o.fetchImage(this.nextImageId).catch(function(){})},handleNext:function(){console.log("next"),this.currentImageIndex=this.nextImageIndex},handlePrevious:function(){console.log("prev"),this.currentImageIndex=this.previousImageIndex},handleRefineTp:function(e){Vue.Promise.all(e.map(this.updateTpPoints)).catch(s.handleErrorResponse)},updateTpPoints:function(e){var n=this;return a.update({id:e.id},{points:e.points}).then(function(){n.tpById[e.id].points=e.points})},focusCurrentTp:function(){console.log("focus")},handleSelectTp:function(e){this.updateSelectTrainingProposal(e,!0)},handleUnselectTp:function(e){this.updateSelectTrainingProposal(e,!1)}},watch:{selectTpTabOpen:function(e){this.visitedSelectTpTab=!0,e&&biigle.$require("keyboard").setActiveSet("select-tp")},refineTpTabOpen:function(e){this.visitedRefineTpTab=!0,e&&biigle.$require("keyboard").setActiveSet("refine-tp")},reviewAcTabOpen:function(e){this.visitedReviewAcTab=!0,open&&biigle.$require("keyboard").setActiveSet("review-ac")},visitedSelectTpTab:function(){this.fetchTrainingProposals()},visitedRefineTpTab:function(){this.fetchTrainingProposals(),this.currentImageIndex=0},visitedReviewAcTab:function(){this.fetchAnnotationCandidates()},currentImageId:function(e){e?Vue.Promise.all([this.fetchImage(e),this.fetchTpAnnotations(e),this.fetchTrainingProposalPromise]).then(this.setCurrentImageAndTpAnnotations).then(this.focusCurrentTp):this.setCurrentImageAndTpAnnotations([null,null])},currentTp:function(e){e&&this.focusCurrentTp()}}})}),biigle.$component("maia.components.acImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("maia.components.acImageGridImage")}}),biigle.$component("maia.components.acImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage")],template:'<figure class="image-grid__image" :class="classObject" :title="title"><div v-if="showIcon" class="image-icon"><i class="fas fa-3x" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div></figure>',computed:{showAnnotationLink:function(){return!1},selected:function(){return this.image.selected},title:function(){return this.selected?"Remove selected label":"Assign selected label"}},methods:{getBlob:function(){return biigle.$require("maia.api.maiaAnnotation").getFile({id:this.image.id})}}}),biigle.$component("maia.components.refineTpCanvas",{mixins:[biigle.$require("annotations.components.annotationCanvas")],props:{unselectedAnnotations:{type:Array,default:function(){return[]}}},data:function(){return{selectingTp:!1}},computed:{},methods:{toggleMarkAsInteresting:function(){this.selectingTp=!this.selectingTp},createUnselectedAnnotationsLayer:function(){this.unselectedAnnotationFeatures=new ol.Collection,this.unselectedAnnotationSource=new ol.source.Vector({features:this.unselectedAnnotationFeatures}),this.unselectedAnnotationLayer=new ol.layer.Vector({source:this.unselectedAnnotationSource,zIndex:50,updateWhileAnimating:!0,updateWhileInteracting:!0,style:biigle.$require("annotations.stores.styles").editing,opacity:.5})},createSelectTpInteraction:function(e){var n=biigle.$require("annotations.ol.AttachLabelInteraction");this.selectTpInteraction=new n({map:this.map,features:e}),this.selectTpInteraction.setActive(!1),this.selectTpInteraction.on("attach",this.handleSelectTp)},handleSelectTp:function(e){this.$emit("select-tp",e.feature.get("annotation"))},handleUnselectTp:function(){this.selectedAnnotations.length>0&&this.$emit("unselect-tp",this.selectedAnnotations[0])}},watch:{unselectedAnnotations:function(e){this.refreshAnnotationSource(e,this.unselectedAnnotationSource)},selectingTp:function(e){this.selectTpInteraction.setActive(e)}},created:function(){this.createUnselectedAnnotationsLayer(),this.map.addLayer(this.unselectedAnnotationLayer),this.selectInteraction.setActive(!1),this.canModify&&(this.createSelectTpInteraction(this.unselectedAnnotationFeatures),this.map.addInteraction(this.selectTpInteraction),biigle.$require("keyboard").on("Delete",this.handleUnselectTp,0,this.listenerSet))}}),biigle.$component("maia.components.refineTpTab",{props:{selectedTrainingProposals:{type:Array,required:!0},seenTrainingProposals:{type:Array,required:!0}},data:function(){return{}},computed:{numberSelectedTps:function(){return this.selectedTrainingProposals.length},numberSeenTps:function(){return this.seenTrainingProposals.length},hasNoSelectedTp:function(){return 0===this.numberSelectedTps},hasSeenAllSelectedTps:function(){return this.numberSelectedTps>0&&this.numberSelectedTps===this.numberSeenTps},textClass:function(){return this.hasSeenAllSelectedTps?"text-success":""},buttonClass:function(){return this.hasSeenAllSelectedTps?"btn-success":"btn-default"}},methods:{},created:function(){}}),biigle.$component("maia.components.reviewAcTab",{props:{},data:function(){return{}},computed:{},methods:{},created:function(){}}),biigle.$component("maia.components.selectTpTab",{props:{trainingProposals:{type:Array,required:!0},selectedTrainingProposals:{type:Array,required:!0}},data:function(){return{}},computed:{selectedTpCount:function(){return this.selectedTrainingProposals.length},tpCount:function(){return this.trainingProposals.length}},methods:{proceed:function(){this.$emit("proceed")}},created:function(){}}),biigle.$component("maia.components.tpImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("maia.components.tpImageGridImage")},props:{selectedTpIds:{type:Object,required:!0}}}),biigle.$component("maia.components.tpImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage")],template:'<figure class="image-grid__image" :class="classObject" :title="title"><div v-if="showIcon" class="image-icon"><i class="fas fa-3x" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div></figure>',computed:{showAnnotationLink:function(){return!1},selected:function(){return this.$parent.selectedTpIds.hasOwnProperty(this.image.id)},title:function(){if(this.selectable)return this.selected?"Undo marking as interesting":"Mark as interesting"}},methods:{getBlob:function(){return biigle.$require("maia.api.maiaAnnotation").getFile({id:this.image.id})}}}),biigle.$declare("maia.api.maiaAnnotation",Vue.resource("api/v1/maia-annotations{/id}",{},{getFile:{method:"GET",url:"api/v1/maia-annotations{/id}/file"}})),biigle.$declare("maia.api.maiaJob",Vue.resource("api/v1/maia-jobs{/id}",{},{save:{method:"POST",url:"api/v1/volumes{/id}/maia-jobs"},getTrainingProposals:{method:"GET",url:"api/v1/maia-jobs{/id}/training-proposals"},getTrainingProposalPoints:{method:"GET",url:"api/v1/maia-jobs{/jobId}/images{/imageId}/training-proposals"},getAnnotationCandidates:{method:"GET",url:"api/v1/maia-jobs{/id}/annotation-candidates"}}));