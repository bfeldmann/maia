biigle.$viewModel("maia-job-form",function(e){new Vue({el:e,data:{showAdvanced:!1},methods:{toggle:function(){this.showAdvanced=!this.showAdvanced}}})}),biigle.$viewModel("maia-show-container",function(e){var n=biigle.$require("maia.job"),i=biigle.$require("maia.states"),t=biigle.$require("maia.api.maiaJob"),s=biigle.$require("maia.api.maiaAnnotation"),a=biigle.$require("messages.store"),o=biigle.$require("annotations.stores.images"),r=[],c={};new Vue({el:e,mixins:[biigle.$require("core.mixins.loader")],components:{sidebar:biigle.$require("annotations.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),selectTpTab:biigle.$require("maia.components.selectTpTab"),tpImageGrid:biigle.$require("maia.components.tpImageGrid"),refineTpTab:biigle.$require("maia.components.refineTpTab"),refineTpCanvas:biigle.$require("maia.components.refineTpCanvas"),reviewAcTab:biigle.$require("maia.components.reviewAcTab"),acImageGrid:biigle.$require("maia.components.acImageGrid")},data:{visitedSelectTpTab:!1,visitedRefineTpTab:!1,visitedReviewAcTab:!1,openTab:"info",fetchTrainingProposalPromise:null,hasTrainingProposals:!1,selectedTrainingProposalIds:{},seenTrainingProposalIds:{},lastSelectedTrainingProposal:null,currentImage:null,currentImageIndex:null,currentTrainingProposals:[],currentTrainingProposalsById:{},focussedTrainingProposal:null,tpAnnotationCache:{},annotationCandidates:[]},computed:{infoTabOpen:function(){return"info"===this.openTab},selectTpTabOpen:function(){return"select-training-proposals"===this.openTab},refineTpTabOpen:function(){return"refine-training-proposals"===this.openTab},reviewAcTabOpen:function(){return"review-annotation-candidates"===this.openTab},isInTrainingProposalState:function(){return n.state_id===i["training-proposals"]},isInAnnotationCandidateState:function(){return n.state_id===i["annotation-candidates"]},trainingProposals:function(){return this.hasTrainingProposals?r:[]},selectedTrainingProposals:function(){return Object.keys(this.selectedTrainingProposalIds).map(function(e){return c[e]})},hasSelectedTrainingProposals:function(){return this.selectedTrainingProposals.length>0},imageIds:function(){var e={};return this.trainingProposals.forEach(function(n){e[n.image_id]=void 0}),Object.keys(e).map(function(e){return parseInt(e,10)})},currentImageId:function(){return this.imageIds[this.currentImageIndex]},nextImageIndex:function(){return(this.currentImageIndex+1)%this.imageIds.length},nextImageId:function(){return this.imageIds[this.nextImageIndex]},nextFocussedImageId:function(){return this.nextFocussedTrainingProposal?this.nextFocussedTrainingProposal.image_id:this.nextImageId},previousImageIndex:function(){return(this.currentImageIndex-1+this.imageIds.length)%this.imageIds.length},previousImageId:function(){return this.imageIds[this.previousImageIndex]},hasCurrentImage:function(){return null!==this.currentImage},currentSelectedTrainingProposals:function(){return this.currentTrainingProposals.filter(function(e){return this.selectedTrainingProposalIds.hasOwnProperty(e.id)},this)},currentUnselectedTrainingProposals:function(){return this.currentTrainingProposals.filter(function(e){return!this.selectedTrainingProposalIds.hasOwnProperty(e.id)},this)},previousFocussedTrainingProposal:function(){var e=(this.selectedTrainingProposals.indexOf(this.focussedTrainingProposal)-1+this.selectedTrainingProposals.length)%this.selectedTrainingProposals.length;return this.selectedTrainingProposals[e]},nextFocussedTrainingProposal:function(){var e=(this.selectedTrainingProposals.indexOf(this.focussedTrainingProposal)+1)%this.selectedTrainingProposals.length;return this.selectedTrainingProposals[e]},focussedTrainingProposalToShow:function(){return this.refineTpTabOpen?this.focussedTrainingProposal:null},focussedTrainingProposalArray:function(){return this.focussedTrainingProposalToShow?this.currentSelectedTrainingProposals.filter(function(e){return e.id===this.focussedTrainingProposalToShow.id},this):[]},selectedAndSeenTrainingProposals:function(){return this.selectedTrainingProposals.filter(function(e){return this.seenTrainingProposalIds.hasOwnProperty(e.id)},this)}},methods:{handleSidebarToggle:function(){this.$nextTick(function(){this.$refs.imageGrid.$emit("resize")})},handleTabOpened:function(e){this.openTab=e},setTrainingProposals:function(e){r=e.body,r.forEach(function(e){c[e.id]=e,this.setSelectedTrainingProposalId(e)},this),this.hasTrainingProposals=r.length>0},fetchTrainingProposals:function(){return this.fetchTrainingProposalPromise||(this.startLoading(),this.fetchTrainingProposalPromise=t.getTrainingProposals({id:n.id}),this.fetchTrainingProposalPromise.then(this.setTrainingProposals).catch(a.handleErrorResponse).finally(this.finishLoading)),this.fetchTrainingProposalPromise},openRefineTpTab:function(){this.openTab="refine-training-proposals"},updateSelectTrainingProposal:function(e,n){e.selected=n,this.setSelectedTrainingProposalId(e);var i=s.update({id:e.id},{selected:n});return i.catch(function(i){a.handleErrorResponse(i),e.selected=!n,this.setSelectedTrainingProposalId(e)}),i},setSelectedTrainingProposalId:function(e){e.selected?Vue.set(this.selectedTrainingProposalIds,e.id,!0):Vue.delete(this.selectedTrainingProposalIds,e.id)},setSeenTrainingProposalId:function(e){Vue.set(this.seenTrainingProposalIds,e.id,!0)},fetchTpAnnotations:function(e){return this.tpAnnotationCache.hasOwnProperty(e)||(this.tpAnnotationCache[e]=t.getTrainingProposalPoints({jobId:n.id,imageId:e}).then(this.parseTpAnnotations)),this.tpAnnotationCache[e]},parseTpAnnotations:function(e){return Object.keys(e.body).map(function(n){return{id:parseInt(n,10),shape:"Circle",points:e.body[n]}})},setCurrentImageAndTpAnnotations:function(e){this.currentImage=e[0],this.currentTrainingProposals=e[1],this.currentTrainingProposalsById={},this.currentTrainingProposals.forEach(function(e){this.currentTrainingProposalsById[e.id]=e},this)},cacheNextImage:function(){this.currentImageId!==this.nextFocussedImageId&&o.fetchImage(this.nextFocussedImageId).catch(function(){})},cacheNextTpAnnotations:function(){this.currentImageId!==this.nextFocussedImageId&&this.fetchTpAnnotations(this.nextFocussedImageId).catch(function(){})},handlePreviousImage:function(){this.currentImageIndex=this.previousImageIndex},handlePrevious:function(){this.previousFocussedTrainingProposal?this.focussedTrainingProposal=this.previousFocussedTrainingProposal:this.handlePreviousImage()},handleNextImage:function(){this.currentImageIndex=this.nextImageIndex},handleNext:function(){this.nextFocussedTrainingProposal?this.focussedTrainingProposal=this.nextFocussedTrainingProposal:this.handleNextImage()},handleRefineTp:function(e){Vue.Promise.all(e.map(this.updateTpPoints)).catch(a.handleErrorResponse)},updateTpPoints:function(e){var n=this.currentTrainingProposalsById[e.id];return s.update({id:e.id},{points:e.points}).then(function(){n.points=e.points})},focusTrainingProposalToShow:function(){if(this.focussedTrainingProposalToShow){var e=this.currentTrainingProposalsById[this.focussedTrainingProposalToShow.id];e&&this.$refs.refineCanvas.focusAnnotation(e,!0,!1)}},handleSelectedTrainingProposal:function(e,n){e.selected?this.unselectTrainingProposal(e):n.shiftKey&&this.lastSelectedTrainingProposal?this.selectAllTpBetween(e,this.lastSelectedTrainingProposal):(this.lastSelectedTrainingProposal=e,this.selectTrainingProposal(e))},selectAllTpBetween:function(e,n){var i=this.trainingProposals.indexOf(e),t=this.trainingProposals.indexOf(n);if(t<i){var s=t;t=i,i=s}for(var a=i+1;a<=t;a++)this.selectTrainingProposal(this.trainingProposals[a])},selectTrainingProposal:function(e){this.updateSelectTrainingProposal(e,!0).then(this.maybeInitFocussedTrainingProposal)},unselectTrainingProposal:function(e){var n=this.nextFocussedTrainingProposal;this.updateSelectTrainingProposal(e,!1).bind(this).then(function(){this.maybeUnsetFocussedTrainingProposal(e,n)})},maybeInitFocussedTrainingProposal:function(){!this.focussedTrainingProposal&&this.hasSelectedTrainingProposals&&(this.focussedTrainingProposal=this.selectedTrainingProposals[0])},maybeUnsetFocussedTrainingProposal:function(e,n){this.focussedTrainingProposal&&this.focussedTrainingProposal.id===e.id&&(n&&n.id!==e.id?this.focussedTrainingProposal=n:this.focussedTrainingProposal=null)},maybeInitCurrentImage:function(){null===this.currentImageIndex&&(this.currentImageIndex=0)},handleLoadingError:function(e){a.danger(e)}},watch:{selectTpTabOpen:function(e){this.visitedSelectTpTab=!0,e&&biigle.$require("keyboard").setActiveSet("select-tp")},refineTpTabOpen:function(e){this.visitedRefineTpTab=!0,e&&(biigle.$require("keyboard").setActiveSet("refine-tp"),this.maybeInitFocussedTrainingProposal())},reviewAcTabOpen:function(e){this.visitedReviewAcTab=!0,e&&biigle.$require("keyboard").setActiveSet("review-ac")},visitedSelectTpTab:function(){this.fetchTrainingProposals()},visitedRefineTpTab:function(){this.fetchTrainingProposals().then(this.maybeInitFocussedTrainingProposal).then(this.maybeInitCurrentImage)},visitedReviewAcTab:function(){this.fetchAnnotationCandidates()},currentImageId:function(e){e?(this.startLoading(),Vue.Promise.all([o.fetchAndDrawImage(e),this.fetchTpAnnotations(e),this.fetchTrainingProposalPromise]).then(this.setCurrentImageAndTpAnnotations).then(this.focusTrainingProposalToShow).then(this.cacheNextImage).then(this.cacheNextTpAnnotations).catch(this.handleLoadingError).finally(this.finishLoading)):this.setCurrentImageAndTpAnnotations([null,null])},focussedTrainingProposalToShow:function(e,n){e&&(n&&n.image_id===e.image_id?this.focusTrainingProposalToShow():this.currentImageIndex=this.imageIds.indexOf(e.image_id),this.setSeenTrainingProposalId(e))}}})}),biigle.$declare("maia.api.maiaAnnotation",Vue.resource("api/v1/maia-annotations{/id}",{},{getFile:{method:"GET",url:"api/v1/maia-annotations{/id}/file"}})),biigle.$declare("maia.api.maiaJob",Vue.resource("api/v1/maia-jobs{/id}",{},{save:{method:"POST",url:"api/v1/volumes{/id}/maia-jobs"},getTrainingProposals:{method:"GET",url:"api/v1/maia-jobs{/id}/training-proposals"},getTrainingProposalPoints:{method:"GET",url:"api/v1/maia-jobs{/jobId}/images{/imageId}/training-proposals"},getAnnotationCandidates:{method:"GET",url:"api/v1/maia-jobs{/id}/annotation-candidates"}})),biigle.$component("maia.components.acImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("maia.components.acImageGridImage")}}),biigle.$component("maia.components.acImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage")],template:'<figure class="image-grid__image" :class="classObject" :title="title"><div v-if="showIcon" class="image-icon"><i class="fas fa-3x" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div></figure>',computed:{showAnnotationLink:function(){return!1},selected:function(){return this.image.selected},title:function(){return this.selected?"Remove selected label":"Assign selected label"}},methods:{getBlob:function(){return biigle.$require("maia.api.maiaAnnotation").getFile({id:this.image.id})}}}),biigle.$component("maia.components.refineTpCanvas",{mixins:[biigle.$require("annotations.components.annotationCanvas")],props:{unselectedAnnotations:{type:Array,default:function(){return[]}}},data:function(){return{selectingTp:!1}},computed:{hasAnnotations:function(){return this.annotations.length>0}},methods:{handlePreviousImage:function(e){this.$emit("previous-image")},handleNextImage:function(e){this.$emit("next-image")},toggleMarkAsInteresting:function(){this.selectingTp=!this.selectingTp},createUnselectedAnnotationsLayer:function(){this.unselectedAnnotationFeatures=new ol.Collection,this.unselectedAnnotationSource=new ol.source.Vector({features:this.unselectedAnnotationFeatures}),this.unselectedAnnotationLayer=new ol.layer.Vector({source:this.unselectedAnnotationSource,zIndex:50,updateWhileAnimating:!0,updateWhileInteracting:!0,style:biigle.$require("annotations.stores.styles").editing,opacity:.5})},createSelectTpInteraction:function(e){var n=biigle.$require("annotations.ol.AttachLabelInteraction");this.selectTpInteraction=new n({map:this.map,features:e}),this.selectTpInteraction.setActive(!1),this.selectTpInteraction.on("attach",this.handleSelectTp)},handleSelectTp:function(e){this.$emit("select-tp",e.feature.get("annotation"))},handleUnselectTp:function(){this.selectedAnnotations.length>0&&this.$emit("unselect-tp",this.selectedAnnotations[0])}},watch:{unselectedAnnotations:function(e){this.refreshAnnotationSource(e,this.unselectedAnnotationSource)},selectingTp:function(e){this.selectTpInteraction.setActive(e)}},created:function(){this.createUnselectedAnnotationsLayer(),this.map.addLayer(this.unselectedAnnotationLayer),this.selectInteraction.setActive(!1),this.canModify&&(this.createSelectTpInteraction(this.unselectedAnnotationFeatures),this.map.addInteraction(this.selectTpInteraction),biigle.$require("keyboard").on("Delete",this.handleUnselectTp,0,this.listenerSet))}}),biigle.$component("maia.components.refineTpTab",{props:{selectedTrainingProposals:{type:Array,required:!0},seenTrainingProposals:{type:Array,required:!0}},data:function(){return{}},computed:{numberSelectedTps:function(){return this.selectedTrainingProposals.length},numberSeenTps:function(){return this.seenTrainingProposals.length},hasNoSelectedTp:function(){return 0===this.numberSelectedTps},hasSeenAllSelectedTps:function(){return this.numberSelectedTps>0&&this.numberSelectedTps===this.numberSeenTps},textClass:function(){return this.hasSeenAllSelectedTps?"text-success":""},buttonClass:function(){return this.hasSeenAllSelectedTps?"btn-success":"btn-default"}},methods:{},created:function(){}}),biigle.$component("maia.components.reviewAcTab",{props:{},data:function(){return{}},computed:{},methods:{},created:function(){}}),biigle.$component("maia.components.selectTpTab",{props:{trainingProposals:{type:Array,required:!0},selectedTrainingProposals:{type:Array,required:!0}},data:function(){return{}},computed:{selectedTpCount:function(){return this.selectedTrainingProposals.length},tpCount:function(){return this.trainingProposals.length}},methods:{proceed:function(){this.$emit("proceed")}},created:function(){}}),biigle.$component("maia.components.tpImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("maia.components.tpImageGridImage")},props:{selectedTpIds:{type:Object,required:!0}}}),biigle.$component("maia.components.tpImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage")],template:'<figure class="image-grid__image" :class="classObject" :title="title"><div v-if="showIcon" class="image-icon"><i class="fas fa-3x" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div></figure>',computed:{showAnnotationLink:function(){return!1},selected:function(){return this.$parent.selectedTpIds.hasOwnProperty(this.image.id)},title:function(){if(this.selectable)return this.selected?"Unselect as interesting":"Select as interesting"}},methods:{getBlob:function(){return biigle.$require("maia.api.maiaAnnotation").getFile({id:this.image.id})}}});